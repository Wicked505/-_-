import requests
import random

from discord.ext import tasks
from discord.ext.commands import Bot, Cog

CHAT_CHANNEL_ID = 731267546052952086

# TODO: create an auth system, where -_- sends the showerthought into a private channel/dms
#  reacts to its own message with a check and an x,
#  if >1 people react with a check (aka an actual person), it sends to the public channel


# gets reddit.com/r/showerthoughts, turns the content into an HTML5 doc accessible by doing soup.content
url = "https://www.reddit.com/r/Showerthoughts/top/?t=day"
dat = {'q': 'goog'}
soup = requests.get(url, params=dat, headers={'User-Agent': 'Chrome/5.0'})
# turn the content into a string
content = str(soup.content)
# turns the string into a list (a very messy one)
part1 = content.partition('<h3 class="_eYtD2XCVieq6emjKBH3m">')
# basically the first bit of the third element is the actual post text,
# and to clean it up we can partition using the ending element text
unsnip = str(part1[2])
# boom, post a
finalmessage = str(unsnip.partition('</h3')[0])

# doing this because 1. cant figure out how to make the variable global, 2. continuity, 3. i dont have a third reason.
MESSAGES = [finalmessage]


class Chatter(Cog):
    """Sends random messages into the general channel. For lolz."""

    def __init__(self, bot: Bot):
        self.bot = bot
        self.channel = None
        self.bot.loop.create_task(self.start())

    async def start(self):
        await self.bot.wait_until_ready()
        self.channel = self.bot.get_channel(CHAT_CHANNEL_ID)
        self.chat.start()
        import asyncio
        await asyncio.sleep(2)

    @tasks.loop(hours=24.0)
    async def chat(self):
        await self.channel.send(random.choice(MESSAGES))


def setup(bot):
    bot.add_cog(Chatter(bot))
